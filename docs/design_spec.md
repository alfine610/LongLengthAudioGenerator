# 設計仕様書

## 1. アプリケーション概要

BGMなどのMP3ファイルから、**ループ区間（繰り返し区間）を直感的に特定し、その範囲をN回繰り返して長尺MP3を生成できるWebアプリ**です。  
波形の似た部分を自動検出する「ループポイント一致個所の特定」機能も備えています。

---

## 2. 要件

### 2.1 必須要件
- MP3ファイルを読み込む
- 波形を表示する（wavesurfer.js＋MUI UI）
- 波形上でループ区間（開始・終了点）を指定
- 区間をN回繰り返して新しいMP3を生成（ffmpeg.wasm）
- 生成MP3のダウンロード

### 2.2 追加要件
- 選択区間のみの再生プレビュー
- ループ回数（N）をUIで指定
- 区間切り出し（1回分のみの抽出）も可能
- **波形の似た部分（ループポイント）を自動検出・候補表示（Web Audio API＋JS自己相関等）**

---

## 3. 技術構成・選定

- **フロントエンドのみ**で動作（10MB程度の音源を想定）
- **UI**: React＋MUI（Material-UI）
- **波形表示・区間選択**: wavesurfer.js（Regionsプラグイン）
- **音声処理・生成**: [ffmpeg.wasm](https://github.com/ffmpegwasm/ffmpeg.wasm)（公式実装）
- **波形類似検出**: Web Audio APIでPCM取得＋JavaScript自己相関アルゴリズム
- **ファイル操作**: ブラウザのみで完結、サーバ不要

### 3.1 FFmpeg.wasm 実装詳細

- **ライブラリ**: `@ffmpeg/ffmpeg` v0.12.10 + `@ffmpeg/util` v0.12.1
- **初期化方法**: toBlobURL + ESM形式での動的読み込み
- **Cross-Origin設定**: COEP/COOP ヘッダー設定済み
- **対応環境**: HTTPS または localhost 必須

---

## 4. 画面・UX設計

- [ファイル選択ボタン]
- [波形表示エリア]
- [ループ区間選択用UI（ドラッグor数値入力）]
- [自動検出ボタン] … 似た波形部分を自動で検出し候補をハイライト
- [開始・終了時間表示]
- [ループ回数指定欄]
- [選択部分の再生ボタン]
- [区間切り出しボタン]
- [生成＆ダウンロードボタン]

---

## 5. 実装方針

- **最小構成（MVP）** ✅ **実装済み**
  - MP3アップロード→波形表示→区間選択→N回ループ→生成・DL
- **追加機能** 🔄 **段階的実装中**
  - 類似区間自動検出ボタン
  - プレビュー再生 ✅
  - UI・UX改善 ✅

### 5.1 実装状況（Phase 2）

#### ✅ **完了済み機能**
- MP3ファイルアップロード・波形表示
- ドラッグ区間選択・時間表示
- 選択区間プレビュー再生
- ループ回数UI設定
- FFmpeg.wasm統合・初期化

#### 🔄 **実装中機能**
- ループ音源生成・ダウンロード
- 区間切り出し・ダウンロード
- エラーハンドリング・ユーザビリティ向上

#### 📋 **未実装機能**
- 自動ループポイント検出
- 数値入力による区間指定
- フェードイン/アウト効果

---

## 6. 拡張性・保守性

- まずは簡単な実装→必要に応じて柔軟に設計変更
- 各機能は独立したReactコンポーネントで管理
- コード整形・静的解析ツール導入推奨

---

## 7. その他

- ドキュメント（README, instructions.md, 本仕様書）を常に最新化
- Issue/PullRequestはGitHub標準フローを利用
