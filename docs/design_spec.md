# 設計仕様書

## 1. アプリケーション概要

BGMなどのMP3ファイルから、**ループ区間（繰り返し区間）を直感的に特定し、その### 5.1 実装状況（Phase 2 - 波形表示問題修正が必要）

#### ✅ **完了済み機能**
- MP3・各種音声ファイルアップロード機能
- ループ回数UI設定（1-100回、スライダー）
- FFmpeg.wasm統合・初期化・ESM最適化
- **ループ音源生成・ダウンロード機能** ✅
- **区間切り出し・ダウンロード機能** ✅
- **リアルタイムプログレス表示** ✅
- **エラーハンドリング・ユーザビリティ向上** ✅
- キーボードショートカット実装

#### 🔧 **修正が必要な機能**
- **波形表示**: wavesurfer.js初期化に問題あり
- **区間選択**: 波形表示問題により機能せず
- **プレビュー再生**: 波形表示問題により機能せず
- **時間表示**: 区間選択ができないため0のまま

#### 🔄 **実装中機能**
- 自動ループポイント検出（Web Audio API + 相関解析）
- 数値入力による精密区間指定
- フェードイン/アウト効果成できるWebアプリ**です。  
波形の似た部分を自動検出する「ループポイント一致個所の特定」機能も備えています。

---

## 2. 要件

### 2.1 必須要件
- ✅ 複数形式音声ファイルを読み込む（MP3, WAV, OGG, M4A）
- ❌ 波形を表示する（wavesurfer.js＋MUI UI）**※現在不具合あり**
- ❌ 波形上でループ区間（開始・終了点）を指定 **※波形表示問題により機能せず**
- ✅ 区間をN回繰り返して新しい音声ファイルを生成（ffmpeg.wasm）
- ✅ 生成音声ファイルのダウンロード

### 2.2 追加要件
- ❌ 選択区間のみの再生プレビュー **※波形表示問題により機能せず**
- ✅ ループ回数（N）をUIで指定（1-100回）
- ✅ 区間切り出し（1回分のみの抽出）も可能
- ✅ キーボードショートカット対応
- ✅ リアルタイムプログレス表示
- 🔄 **波形の似た部分（ループポイント）を自動検出・候補表示（Web Audio API＋JS自己相関等）**

---

## 3. 技術構成・選定

- **フロントエンドのみ**で動作（10MB程度の音源を想定）
- **UI**: React＋MUI（Material-UI）
- **波形表示・区間選択**: wavesurfer.js（Regionsプラグイン）
- **音声処理・生成**: [ffmpeg.wasm](https://github.com/ffmpegwasm/ffmpeg.wasm)（公式実装）
- **波形類似検出**: Web Audio APIでPCM取得＋JavaScript自己相関アルゴリズム
- **ファイル操作**: ブラウザのみで完結、サーバ不要

### 3.1 FFmpeg.wasm 実装詳細

- **ライブラリ**: `@ffmpeg/ffmpeg` v0.12.10 + `@ffmpeg/util` v0.12.1
- **初期化方法**: toBlobURL + ESM形式での動的読み込み
- **Cross-Origin設定**: COEP/COOP ヘッダー設定済み
- **対応環境**: HTTPS または localhost 必須

---

## 4. 画面・UX設計

- [ファイル選択ボタン]
- [波形表示エリア]
- [ループ区間選択用UI（ドラッグor数値入力）]
- [自動検出ボタン] … 似た波形部分を自動で検出し候補をハイライト
- [開始・終了時間表示]
- [ループ回数指定欄]
- [選択部分の再生ボタン]
- [区間切り出しボタン]
- [生成＆ダウンロードボタン]

---

## 5. 実装方針

- **最小構成（MVP）** ✅ **実装済み**
  - MP3アップロード→波形表示→区間選択→N回ループ→生成・DL
- **追加機能** 🔄 **段階的実装中**
  - 類似区間自動検出ボタン
  - プレビュー再生 ✅
  - UI・UX改善 ✅

### 5.1 実装状況（Phase 2 完了）

#### ✅ **完了済み機能**
- MP3・各種音声ファイルアップロード・波形表示
- ドラッグ区間選択・時間表示・数値フィードバック
- 選択区間プレビュー再生・キーボードショートカット
- ループ回数UI設定（1-100回、スライダー）
- FFmpeg.wasm統合・初期化・ESM最適化
- **ループ音源生成・ダウンロード機能** ✅
- **区間切り出し・ダウンロード機能** ✅
- **リアルタイムプログレス表示** ✅
- **エラーハンドリング・ユーザビリティ向上** ✅

#### � **実装中機能**
- 自動ループポイント検出（Web Audio API + 相関解析）
- 数値入力による精密区間指定
- フェードイン/アウト効果

#### 📋 **未実装機能**
- 複数候補ループポイント表示
- 波形画質・表示設定カスタマイズ
- バッチ処理（複数ファイル同時処理）

---

## 6. 拡張性・保守性

- まずは簡単な実装→必要に応じて柔軟に設計変更
- 各機能は独立したReactコンポーネントで管理
- コード整形・静的解析ツール導入推奨

---

## 7. その他

- ドキュメント（README, instructions.md, 本仕様書）を常に最新化
- Issue/PullRequestはGitHub標準フローを利用
